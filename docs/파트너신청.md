# 파트너 신청 및 처리 플로우

## 개요
본 시스템은 계층적 파트너 네트워크를 관리하는 포괄적인 플랫폼입니다. JWT 인증 기반의 샤딩된 사용자 시스템에서 동작하며, 추천 기반의 다단계 파트너 구조를 지원합니다.

## 시스템 구조

### 주요 컴포넌트
- **파트너 등급 시스템**: Bronze → Silver → Gold → Platinum 4단계 등급
- **파트너 타입 시스템**: 6가지 전문 분야별 타입 (세일즈, 기술지원, 마케팅, 교육, 컨설팅, 고객서비스)
- **추천 시스템**: 9가지 추천 경로 및 추천 보너스 관리
- **승인 시스템**: 관리자 및 상위 파트너 승인 프로세스
- **재신청 시스템**: 거부된 신청자의 재심사 프로세스

### 데이터베이스 구조
- `partner_tiers`: 파트너 등급 관리 (수수료율, 요구사항, 혜택)
- `partner_types`: 파트너 타입 관리 (전문분야, 필수스킬, 인증)
- `partner_applications`: 파트너 신청서 관리 (개인정보, 경력, 승인상태)
- `partner_users`: 승인된 파트너 정보 관리
- `partner_network_relationships`: 파트너 계층 관계 관리

---

## 1. 사전 준비

### 1.1 회원가입 요구사항
파트너 신청을 위해서는 먼저 회원가입이 필요합니다.

**시스템 특징:**
- JWT 기반 인증 시스템
- 사용자 샤딩 지원 (`user_uuid` 기반)
- 다중 테이블 구조 (`user_xxx`)

**접속 경로:**
1. 기본 회원가입: `/register`
2. 파트너 전용 랜딩: `/home/partner`

---

## 2. 파트너 신청 프로세스

### 2.1 신청 시작
파트너는 기존 가입된 회원을 기반으로 추가로 가입하는 기능입니다. 회원정보를 읽어와서 자동으로 삽입합니다.
**URL**: `/home/partner/regist`

> 파트너 가입페이지는 `HomeController`를 상속받아 현재 로그인된 사용자의 정보를 확인할 수 있습니다.
> JWT 토큰을 통해 현재 로그인된 사용자의 `user_uuid`와 개인정보를 자동으로 로드하여 신청서에 미리 채워넣습니다.


**신청서 구성 요소:**

#### 2.1.1 개인정보 (`personal_info`)
```json
{
  "name": "홍길동",
  "phone": "010-1234-5678",
  "birth_year": 1990,
  "region": "서울",
  "district": "강남구",
  "address": "상세 주소",
  "education_level": "대학교 졸업",
  "emergency_contact": {
    "name": "홍부모",
    "phone": "010-9876-5432",
    "relationship": "부모"
  }
}
```

#### 2.1.2 경력정보 (`experience_info`)
```json
{
  "total_years": 5,
  "career_summary": "웹 개발 5년 경력",
  "previous_companies": [
    {
      "company": "ABC 회사",
      "position": "시니어 개발자",
      "period": "2020-2023",
      "description": "주요 업무 설명"
    }
  ],
  "portfolio_url": "https://portfolio.com"
}
```

#### 2.1.3 기술정보 (`skills_info`)
```json
{
  "primary_skills": ["PHP", "Laravel", "JavaScript"],
  "secondary_skills": ["Python", "React"],
  "certifications": ["정보처리기사"],
  "languages": ["Korean", "English"]
}
```

#### 2.1.4 서류 첨부 (`documents`)
서류를 첨부하는 경우 `/storage/public/partner/{user_uuid}/` 디렉토리 안에 파일을 업로드 합니다.

**업로드 경로 구조:**
```
/storage/public/partner/{user_uuid}/
├── resume/           # 이력서 파일
├── certificates/     # 자격증 파일들
├── portfolio/        # 포트폴리오 관련 파일
└── additional/       # 기타 추가 서류
```

```json
{
  "resume": "/storage/public/partner/{user_uuid}/resume/이력서.pdf",
  "portfolio_url": "https://portfolio.com",
  "certificates": [
    "/storage/public/partner/{user_uuid}/certificates/정보처리기사.pdf"
  ],
  "additional": [
    "/storage/public/partner/{user_uuid}/additional/추천서.pdf"
  ]
}
```

### 2.2 추천 시스템
파트너를 가입할때 추천 파트너를 등록합니다. 즉, 추천 파트너를 상위 파트너로 지정하는 역할을 수행합니다.
상위파트너는 이메일로 검색을 할 수 있도록하고, 회원의 샤딩번호, uuid 정보를 읽어와서 추천파트너 정보로 같이 저장이 되어야 합니다. 

#### 2.2.1 추천 경로 (`referral_source`)
1. **direct**: 직접 추천
2. **online_link**: 온라인 링크
3. **offline_meeting**: 오프라인 미팅
4. **social_media**: 소셜미디어
5. **event**: 이벤트/세미나
6. **advertisement**: 광고
7. **word_of_mouth**: 구전
8. **self_application**: 자율 지원
9. **other**: 기타

#### 2.2.2 추천 상세 정보 (`referral_details`)
```json
{
  "referrer_name": "김파트너",
  "referrer_email": "partner@example.com",
  "referrer_uuid": "referrer-uuid-string",
  "referrer_shard_id": 3,
  "referrer_contact": "010-1234-5678",
  "meeting_location": "서울 강남구 카페",
  "meeting_date": "2025-11-01",
  "introduction_method": "지인 소개",
  "motivation": "파트너 사업에 관심",
  "referrer_relationship": "회사 동료"
}
```

> **추천인 검색 방식**: 이메일을 통해 추천인을 검색하면 자동으로 해당 사용자의 `user_uuid`와 `shard_id`를 조회하여 추천인 정보로 저장합니다.

### 2.3 신청서 상태 관리
파트너를 가입신청하게 되면 신청 상황을 이력 관리 합니다.

#### 2.3.1 상태 전환도
```
draft → submitted → reviewing → interview → [approved|rejected]
  ↓                                               ↓
  └─────────────── reapplied ←──────────────────┘
```

#### 2.3.2 각 상태별 설명
- **draft**: 작성 중 (임시저장)
- **submitted**: 제출됨 (검토 대기)
- **reviewing**: 검토 중 (담당자 배정)
- **interview**: 면접 예정/진행
- **approved**: 승인됨 (파트너 등록)
- **rejected**: 거부됨 (재신청 가능)
- **reapplied**: 재신청 상태

---

## 3. 신청 상태 확인
파트너 신청을 하게 되면 진행 상태를 확인할 수 있습니다.

### 3.1 상태 페이지
자신의 등록 상태를 확인합니다.

**URL**: `/home/partner/regist/{id}/status`

**제공 정보:**
- 현재 신청 상태
- 진행 단계 표시
- 담당자 정보 (배정 시)
- 다음 단계 안내
- 필요 시 추가 서류 요청

### 3.2 알림 시스템
- 상태 변경 시 이메일/SMS 알림
- 면접 일정 알림
- 승인/거부 결과 알림
- 재신청 가능 알림

---

## 4. 면접 프로세스
관리자 및 상위 파트너는 면접을 요청할 수 있습니다. 

### 4.1 면접 요청
**담당자 권한:**
- 관리자 (`/admin/partner/interview`)
- 상위 파트너 (`/home/partner/interview`)

**면접 관리 기능:**
- 면접 일정 설정 (`interview_date`)
- 면접 노트 작성 (`interview_notes`)
- 면접 결과 기록 (`interview_feedback`)

### 4.2 면접 평가 항목
```json
{
  "technical_skills": 85,
  "communication": 90,
  "motivation": 88,
  "experience_relevance": 82,
  "overall_rating": 86,
  "recommendation": "approved",
  "feedback": "우수한 기술력과 의사소통 능력",
  "concerns": [],
  "action_items": ["추가 교육 필요한 영역"]
}
```

---

## 5. 승인 프로세스

### 5.1 승인 권한 체계
파트너 승인은 **관리자**와 **상위 파트너**만 수행할 수 있습니다.

#### 5.1.1 관리자 승인 시스템
**접속 URL**: `http://localhost:8000/admin/partner/approval`

**관리자 전용 기능:**
- 모든 신청서 승인/거부 권한 (등급/타입 무관)
- 파트너 등급 및 타입 지정 권한
- 특별 조건 및 예외 사항 설정 권한
- 승인 프로세스 우선순위 변경 권한
- 대량 승인/거부 처리 기능

**관리자 승인 화면 기능:**
- 신청서 목록 조회 및 필터링
- 신청자 상세 정보 및 서류 검토
- 면접 일정 관리 및 평가 결과 확인
- 승인/거부 사유 입력 및 피드백 작성
- 파트너 등급/타입 선택
- 수수료율 개별 설정 (필요시)

#### 5.1.2 상위 파트너 승인 (위임된 권한)
**접속 URL**: `/home/partner/approval`

**상위 파트너 권한 제한:**
- 자신보다 낮은 등급만 승인 가능 (Gold 파트너 → Bronze/Silver만 승인)
- 자신과 동일한 타입 또는 지정된 타입만 승인 가능
- 최대 관리 가능 하위 파트너 수 제한 (등급별 차등)
- 특별 조건 설정 불가 (표준 조건만 적용)
- 개별 수수료율 설정 불가 (표준 수수료율 적용)

**상위 파트너 승인 제한 사항:**
```php
// 승인 권한 매트릭스
Bronze 파트너: 승인 권한 없음
Silver 파트너: Bronze 등급만 승인 가능 (최대 5명)
Gold 파트너: Bronze/Silver 등급 승인 가능 (최대 15명)
Platinum 파트너: 모든 등급 승인 가능 (최대 50명)
```

### 5.2 관리자 승인 프로세스 상세

#### 5.2.1 관리자 승인 단계별 절차
**1단계: 신청서 목록 검토**
- 접속: `http://localhost:8000/admin/partner/approval`
- 신청 상태별 필터링 (submitted, reviewing, interview)
- 신청일, 추천자, 파트너 타입별 정렬
- 우선순위 신청서 마킹

**2단계: 개별 신청서 상세 검토**
```php
// 검토 항목
- 개인정보 완성도 확인
- 경력 및 기술 정보 검증
- 첨부 서류 검토 (이력서, 포트폴리오, 자격증)
- 추천인 정보 및 관계 확인
- 동기 및 목표 적합성 평가
```

**3단계: 면접 및 평가 관리**
- 면접 일정 설정 및 담당자 배정
- 면접 결과 및 평가 점수 검토
- 추가 질의사항 또는 보완 요청

**4단계: 최종 승인/거부 결정**
- 승인 시: 파트너 등급 및 타입 지정
- 거부 시: 상세한 거부 사유 및 개선 방향 제시
- 특별 조건 설정 (수수료율, 제한사항 등)

#### 5.2.2 상위 파트너 승인 프로세스

**Bronze 파트너: 승인 권한 없음**
- 신청 추천만 가능
- 추천 보너스 수령 자격

**Silver 파트너 (최대 5명 관리)**
```php
승인 가능 등급: Bronze만
승인 가능 타입: 자신과 동일 타입만
월 승인 한도: 2명
기본 수수료율: 60% (변경 불가)
```

**Gold 파트너 (최대 15명 관리)**
```php
승인 가능 등급: Bronze, Silver
승인 가능 타입: 자신과 동일 타입 + 1개 추가 타입
월 승인 한도: 5명
기본 수수료율: Bronze 60%, Silver 65%
```

**Platinum 파트너 (최대 50명 관리)**
```php
승인 가능 등급: Bronze, Silver, Gold
승인 가능 타입: 모든 타입
월 승인 한도: 15명
기본 수수료율: 표준 수수료율 적용
특별 권한: 긴급 승인 (24시간 내 처리)
```

### 5.3 승인 시 자동 처리

#### 5.3.1 파트너 계정 생성
1. `partner_users` 테이블에 레코드 생성
2. 지정된 등급 (Bronze/Silver/Gold/Platinum) 배정
3. 추천인 기반 계층 구조 설정
4. 등급별 권한 및 제한사항 배정
5. 초기 성과 지표 설정

#### 5.3.2 추천 보너스 처리
1. 추천자 보너스 계산 (등급별 차등)
2. 보너스 지급 예약 (승인 완료 후 7일)
3. 추천 실적 업데이트
4. 추천인의 하위 파트너 카운트 증가

#### 5.3.3 알림 및 후속 처리
1. 신청자에게 승인/거부 알림 발송
2. 추천인에게 결과 알림 발송
3. 승인 시 초기 교육 프로그램 자동 등록
4. 파트너 대시보드 접근 권한 활성화

---

## 6. 거부 및 재신청 프로세스

### 6.1 거부 처리
**거부 사유 분류:**
- 자격 미달
- 서류 불완전
- 면접 결과 미달
- 기타 사유

**거부 시 처리:**
- 거부 사유 상세 기록
- 재신청 가능 조건 안내
- 개선 방향 제시

### 6.2 재신청 프로세스

#### 6.2.1 재신청 페이지
**URL**: `/home/partner/regist/{id}/reapply`

**재신청 특징:**
- 기존 정보 자동 로드
- 거부 사유 표시
- 개선사항 입력 필수

#### 6.2.2 재신청 추가 필드
```json
{
  "improvement_plan": "개선 계획 상세 설명",
  "additional_experience": "추가 경력 사항",
  "new_certifications": "새로 취득한 자격증",
  "motivation_update": "재신청 동기"
}
```

---

## 7. 파트너 등급 시스템

### 7.1 등급별 상세 정보

#### 7.1.1 브론즈 파트너
- **수수료율**: 60%
- **최대 동시 작업**: 2개
- **지원 응답**: 24시간 내
- **승급 조건**: 50건 완료, 평점 4.0 이상

#### 7.1.2 실버 파트너
- **수수료율**: 65%
- **최대 동시 작업**: 4개
- **지원 응답**: 12시간 내
- **승급 조건**: 150건 완료, 평점 4.5 이상

#### 7.1.3 골드 파트너
- **수수료율**: 70%
- **최대 동시 작업**: 6개
- **지원 응답**: 6시간 내
- **리더십 권한**: 하위 파트너 멘토링

#### 7.1.4 플래티넘 파트너
- **수수료율**: 75%
- **최대 동시 작업**: 10개
- **지원 응답**: 즉시
- **특별 혜택**: VIP 프로젝트 접근, 스톡옵션

---

## 8. 파트너 타입 시스템

### 8.1 타입별 전문 분야

#### 8.1.1 세일즈 파트너
- **전문 분야**: 영업, 고객 발굴, 계약 성사
- **목표 매출**: 월 500만원
- **필수 스킬**: 커뮤니케이션, 협상, CRM 사용
- **인증**: 영업 전문가 자격증

#### 8.1.2 기술 지원 파트너
- **전문 분야**: 기술 문제 해결, 설치 지원
- **목표 지원**: 월 100건
- **필수 스킬**: 기술 지식, 문제 해결, 문서화
- **인증**: 기술지원 전문가

#### 8.1.3 마케팅 파트너
- **전문 분야**: 디지털 마케팅, 콘텐츠 제작
- **목표 매출**: 월 300만원
- **필수 스킬**: 창의성, 콘텐츠 작성, 분석
- **인증**: 디지털 마케팅 전문가

#### 8.1.4 교육 파트너
- **전문 분야**: 고객 교육, 트레이닝
- **목표 교육**: 월 80건
- **필수 스킬**: 프레젠테이션, 교육 설계
- **인증**: 교육 전문가

#### 8.1.5 컨설턴트 파트너
- **전문 분야**: 비즈니스 컨설팅, 전략 수립
- **목표 매출**: 월 800만원
- **필수 스킬**: 분석력, 비즈니스 통찰력
- **인증**: 경영 컨설턴트

#### 8.1.6 고객 서비스 파트너
- **전문 분야**: 고객 문의, 사후 관리
- **목표 지원**: 월 120건
- **필수 스킬**: 공감능력, 인내심
- **인증**: 고객서비스 전문가

---

## 9. API 엔드포인트

### 9.1 신청 관련 API
```php
// 신청서 조회
GET /home/partner/regist

// 신청서 작성 페이지
GET /home/partner/regist/create

// 신청서 저장 (임시저장/제출)
POST /home/partner/regist

// 신청 상태 조회
GET /home/partner/regist/{id}/status

// 신청서 수정
GET /home/partner/regist/{id}/edit
PUT /home/partner/regist/{id}

// 재신청
GET /home/partner/regist/{id}/reapply
POST /home/partner/regist/{id}/reapply
```

### 9.2 관리자 승인 API
```php
// 관리자 승인 대시보드
GET /admin/partner/approval

// 신청서 목록 (필터링 지원)
GET /admin/partner/applications
GET /admin/partner/applications?status=submitted
GET /admin/partner/applications?tier=bronze&type=sales

// 신청서 상세 검토
GET /admin/partner/applications/{id}
GET /admin/partner/applications/{id}/documents
GET /admin/partner/applications/{id}/referrer

// 승인 프로세스 관리
POST /admin/partner/applications/{id}/review
POST /admin/partner/applications/{id}/approve
POST /admin/partner/applications/{id}/reject
PUT /admin/partner/applications/{id}/status

// 면접 관리
POST /admin/partner/applications/{id}/interview/schedule
PUT /admin/partner/applications/{id}/interview/update
POST /admin/partner/applications/{id}/interview/complete

// 대량 처리
POST /admin/partner/applications/bulk-approve
POST /admin/partner/applications/bulk-reject

// 승인 통계 및 보고서
GET /admin/partner/approval/statistics
GET /admin/partner/approval/reports
```

### 9.3 상위 파트너 승인 API
```php
// 상위 파트너 승인 대시보드
GET /home/partner/approval

// 승인 가능한 신청서 목록 (권한 기반 필터링)
GET /home/partner/applications/pending

// 하위 파트너 신청서 검토
GET /home/partner/applications/{id}/review

// 제한적 승인/거부 (권한 범위 내)
POST /home/partner/applications/{id}/approve
POST /home/partner/applications/{id}/reject

// 추천 및 후보 관리
GET /home/partner/referrals
POST /home/partner/referrals/recommend

// 승인 한도 및 권한 확인
GET /home/partner/approval/limits
GET /home/partner/approval/permissions
```

---

## 10. 보안 및 권한

### 10.1 JWT 인증
- 모든 파트너 관련 기능은 JWT 인증 필요
- 토큰 만료 시간: 24시간
- 자동 갱신 지원

### 10.2 권한 체계
```php
// 기본 사용자 권한
- partner.apply: 신청서 작성/수정
- partner.view: 자신의 신청서 조회
- partner.reapply: 재신청
- partner.status: 신청 상태 확인

// 관리자 전용 권한
- partner.admin.view_all: 모든 신청서 조회
- partner.admin.approve: 모든 신청서 승인 (무제한)
- partner.admin.reject: 모든 신청서 거부
- partner.admin.interview: 면접 관리 및 평가
- partner.admin.bulk: 대량 승인/거부 처리
- partner.admin.statistics: 승인 통계 및 보고서
- partner.admin.override: 특별 조건 및 예외 설정

// Bronze 파트너 권한
- partner.referral: 추천만 가능 (승인 권한 없음)
- partner.bonus: 추천 보너스 수령

// Silver 파트너 권한 (Bronze 대상)
- partner.approve.bronze: Bronze 등급만 승인
- partner.manage.limited: 최대 5명 관리
- partner.approve.monthly: 월 2명 승인 한도
- partner.approve.same_type: 동일 타입만 승인

// Gold 파트너 권한 (Bronze, Silver 대상)
- partner.approve.bronze_silver: Bronze/Silver 등급 승인
- partner.manage.medium: 최대 15명 관리
- partner.approve.monthly: 월 5명 승인 한도
- partner.approve.multi_type: 동일 타입 + 1개 추가 타입

// Platinum 파트너 권한 (모든 등급 대상)
- partner.approve.all_tiers: 모든 등급 승인
- partner.manage.large: 최대 50명 관리
- partner.approve.monthly: 월 15명 승인 한도
- partner.approve.all_types: 모든 타입 승인
- partner.approve.urgent: 24시간 긴급 승인
```

### 10.3 접근 제어 및 보안 정책

#### 10.3.1 관리자 승인 보안
- **접속 제한**: `/admin/partner/approval`은 관리자 권한 필수
- **IP 화이트리스트**: 지정된 IP에서만 접근 가능
- **세션 타임아웃**: 관리자 세션 30분 자동 만료
- **감사 로그**: 모든 승인/거부 결정 기록
- **이중 인증**: 중요한 승인 결정 시 2차 인증 필요

#### 10.3.2 상위 파트너 승인 보안
- **권한 검증**: 매 요청마다 파트너 등급 및 한도 확인
- **월별 한도**: 등급별 월 승인 한도 자동 차단
- **타입 제한**: 승인 가능한 파트너 타입 실시간 검증
- **상호 승인 금지**: 서로 추천한 파트너 간 승인 불가
- **재승인 제한**: 한 번 거부한 신청자 재승인 시 관리자 확인

### 10.4 데이터 보안
- 개인정보 암호화 저장
- 로그 기록 및 감사 추적
- GDPR 준수 데이터 처리

---

## 11. 성능 최적화

### 11.1 데이터베이스 최적화
- 적절한 인덱스 설정
- 쿼리 최적화
- 캐싱 전략

### 11.2 파일 관리
- 첨부파일 CDN 저장
- 이미지 최적화
- 파일 크기 제한

---

## 12. 모니터링 및 로깅

### 12.1 주요 메트릭
- 신청서 제출률
- 승인/거부율
- 평균 처리 시간
- 재신청률

### 12.2 로그 기록
- 모든 상태 변경 로그
- 승인/거부 결정 로그
- 시스템 오류 로그
- 성능 메트릭 로그

---

## 13. 시스템 구현 현황

### 13.1 구현 완료 기능
- **관리자 승인 프로세스**: `/admin/partner/approval` 완전 구현
- **상위 파트너 승인 시스템**: `/home/partner/approval` 계층적 승인 구현
- **추천인 검색 시스템**: 이메일 기반 `user_xxx` 테이블 검색
- **파일 업로드 시스템**: UUID 기반 디렉토리 구조 (`/storage/public/partner/{user_uuid}/`)
- **헬퍼 서비스**: 알림, 로깅, 성과 관리, 교육, 승인 프로세스 서비스
- **종합적인 API**: 문서화된 모든 엔드포인트 구현

### 13.2 주요 구현 컴포넌트

#### 13.2.1 상위 파트너 승인 시스템
```php
// 등급별 승인 권한 매트릭스
Bronze: 승인 권한 없음 (추천만 가능)
Silver: Bronze만 승인 (월 2명, 최대 5명 관리)
Gold: Bronze/Silver 승인 (월 5명, 최대 15명 관리)
Platinum: 모든 등급 승인 (월 15명, 최대 50명 관리)
```

#### 13.2.2 파일 업로드 서비스
```php
PartnerFileUploadService::uploadPartnerFiles($userUuid, $files)
// 자동 디렉토리 구조 생성:
// /storage/public/partner/{user_uuid}/resume/
// /storage/public/partner/{user_uuid}/certificates/
// /storage/public/partner/{user_uuid}/portfolio/
// /storage/public/partner/{user_uuid}/additional/
```

#### 13.2.3 추천인 검색 시스템
```php
ReferrerController::searchUserByEmail($email)
// 검색 순서: user_profile → user_auth → 기타 user_xxx 테이블
// 반환: user_uuid, shard_id, 파트너 자격 정보
```

#### 13.2.4 헬퍼 서비스들
- **PartnerNotificationService**: 상태 변경, 면접, 승인/거부 알림
- **PartnerActivityLogService**: 모든 파트너 활동 로깅 및 감사 추적
- **PartnerPerformanceService**: 성과 지표 관리 및 등급 승진 계산
- **PartnerTrainingService**: 교육 프로그램 관리 및 진도 추적
- **PartnerApprovalService**: 다단계 승인 워크플로우 자동화

### 13.3 향후 개선 계획

#### 13.3.1 단기 개선사항
- AI 기반 서류 검토 자동화
- 자동 추천 매칭 알고리즘
- 모바일 앱 지원
- 실시간 알림 시스템

#### 13.3.2 장기 개선사항
- 블록체인 기반 투명성 강화
- 국제화 지원 (다국어)
- 머신러닝 기반 성과 예측
- 고급 분석 대시보드

